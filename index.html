<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>IELTS Writing Test - Set Three</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="description" content="Secure IELTS Writing Test Platform with anti-cheating features and Telegram integration">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    :root {
      --primary-blue: #0078d7;
      --primary-red: #d32f2f;
      --primary-green: #28a745;
      --warning-yellow: #fff3cd;
      --warning-border: #ffeaa7;
      --success-bg: #d4edda;
      --error-bg: #f8d7da;
      --light-bg: #f8f9fa;
      --border-color: #ccc;
      --text-dark: #333;
      --text-light: #666;
    }
    
    * { 
      box-sizing: border-box; 
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      background: #fff;
      line-height: 1.6;
      color: var(--text-dark);
    }
    
    /* Header Styles */
    .header {
      background-color: white;
      padding: 15px 30px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: relative;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .header img {
      height: 30px;
      width: auto;
    }
    
    .top-right-info {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 8px;
    }
    
    .timer-display {
      font-weight: bold;
      font-size: 18px;
      color: var(--primary-red);
      background-color: var(--light-bg);
      padding: 8px 15px;
      border-radius: 6px;
      border: 2px solid var(--primary-red);
      min-width: 100px;
      text-align: center;
      font-family: 'Courier New', monospace;
    }
    
    .violation-counter {
      background-color: var(--warning-yellow);
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 13px;
      color: #856404;
      border: 1px solid var(--warning-border);
      font-weight: 600;
    }
    
    .student-name-display {
      font-weight: bold;
      line-height: 1.4;
      font-size: 15px;
    }
    
    /* Test Info Bar */
    .test-info {
      background-color: #e9f7fe;
      padding: 12px 30px;
      border-bottom: 1px solid #b8daff;
      font-size: 15px;
      color: #004085;
      font-weight: 600;
    }
    
    .part-bar {
      background-color: #f2f4ec;
      padding: 15px 30px;
      font-size: 16px;
      border-bottom: 1px solid var(--border-color);
      font-weight: 600;
    }
    
    /* Main Content Area */
    .main {
      display: flex;
      height: calc(100vh - 250px);
      overflow: hidden;
    }
    
    .left, .right {
      padding: 20px 30px;
      overflow-y: auto;
    }
    
    .left {
      width: 50%;
      border-right: 4px solid #999;
      resize: horizontal;
      overflow: auto;
      min-width: 250px;
      max-width: 70%;
      background: #fdfdfd;
    }
    
    .right {
      width: 50%;
      resize: horizontal;
      min-width: 250px;
      max-width: 70%;
    }
    
    /* Task Content */
    .task-content {
      margin-top: 15px;
    }
    
    .task-content p {
      margin-bottom: 15px;
      line-height: 1.6;
    }
    
    .task-content .task-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-dark);
      margin-bottom: 15px;
    }
    
    .task-content .task-instructions {
      color: var(--text-light);
      font-style: italic;
      margin-top: 15px;
      padding-left: 15px;
      border-left: 3px solid var(--primary-blue);
      background: #f8f9fa;
      padding: 10px 15px;
      border-radius: 4px;
    }
    
    .image-container {
      margin: 20px 0;
    }
    
    .image-container img {
      width: 100%;
      height: auto;
      margin-top: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    /* Text Area */
    textarea {
      width: 100%;
      height: calc(100% - 70px);
      font-size: 16px;
      padding: 15px;
      resize: none;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      line-height: 1.6;
      transition: border-color 0.3s ease;
    }
    
    textarea:focus {
      outline: none;
      border-color: var(--primary-blue);
      box-shadow: 0 0 0 3px rgba(0,120,215,0.1);
    }
    
    textarea:disabled {
      background-color: #f8f9fa;
      cursor: not-allowed;
    }
    
    /* Word Count & Typing Speed */
    .word-count {
      text-align: right;
      font-size: 14px;
      margin-top: 8px;
      font-weight: 600;
    }
    
    .word-count.warning {
      color: var(--primary-red);
      animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.7; }
      100% { opacity: 1; }
    }
    
    .typing-speed {
      text-align: right;
      font-size: 12px;
      color: var(--text-light);
      margin-top: 2px;
      height: 16px;
    }
    
    .typing-speed.warning {
      color: var(--primary-red);
      font-weight: bold;
    }
    
    /* Tab Buttons */
    .tab-buttons {
      display: flex;
      justify-content: center;
      border-top: 1px solid var(--border-color);
      background: #f9f9f9;
      padding: 0 30px;
    }
    
    .tab-buttons button {
      flex: 1;
      padding: 12px;
      border: none;
      cursor: pointer;
      font-weight: bold;
      background: #eee;
      font-size: 16px;
      transition: all 0.3s ease;
      border-bottom: 3px solid transparent;
    }
    
    .tab-buttons button:hover {
      background: #e0e0e0;
    }
    
    .tab-buttons button.active {
      background: #d0d0d0;
      border-bottom: 3px solid var(--primary-blue);
    }
    
    /* Buttons */
    .submit-btn, .review-btn {
      padding: 12px 30px;
      margin: 15px auto;
      font-size: 16px;
      cursor: pointer;
      display: block;
      border-radius: 6px;
      border: none;
      font-weight: 600;
      transition: all 0.3s ease;
      min-width: 200px;
    }
    
    .submit-btn {
      background-color: var(--primary-blue);
      color: white;
    }
    
    .submit-btn:hover {
      background-color: #106ebe;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    .submit-btn:disabled {
      background-color: #6c757d;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    .review-btn {
      background-color: #6c757d;
      color: white;
    }
    
    .review-btn:hover {
      background-color: #5a6268;
    }
    
    /* Rules Screen */
    #rulesScreen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      z-index: 1000;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 20px;
      overflow-y: auto;
    }
    
    .rules-container {
      width: 90%;
      max-width: 800px;
      max-height: 85vh;
      overflow-y: auto;
      background-color: white;
      padding: 40px;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.15);
      border: 1px solid rgba(255,255,255,0.3);
    }
    
    .rules-container h1 {
      color: var(--primary-blue);
      text-align: center;
      margin-bottom: 25px;
      font-size: 32px;
      border-bottom: 2px solid var(--primary-blue);
      padding-bottom: 15px;
    }
    
    .rules-container h2 {
      color: var(--text-dark);
      margin-top: 30px;
      margin-bottom: 15px;
      font-size: 22px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .rules-container h2:before {
      content: "‚ñ∂";
      color: var(--primary-blue);
      font-size: 16px;
    }
    
    .rules-container p, .rules-container ul {
      margin-bottom: 20px;
      line-height: 1.7;
    }
    
    .rules-container ul {
      padding-left: 25px;
    }
    
    .rules-container li {
      margin-bottom: 10px;
      position: relative;
      padding-left: 10px;
    }
    
    .rules-container li:before {
      content: "‚Ä¢";
      color: var(--primary-blue);
      font-weight: bold;
      position: absolute;
      left: -15px;
    }
    
    .rules-container .warning {
      background-color: var(--warning-yellow);
      border: 1px solid var(--warning-border);
      border-radius: 8px;
      padding: 20px;
      margin: 25px 0;
      border-left: 5px solid var(--primary-red);
    }
    
    .rules-container .warning h2 {
      color: #856404;
      margin-top: 0;
    }
    
    /* Teacher Selection */
    .teacher-selection {
      margin: 25px 0;
      padding: 20px;
      background: linear-gradient(135deg, #e9f7fe 0%, #cce7ff 100%);
      border-radius: 10px;
      border: 2px solid var(--primary-blue);
    }
    
    .teacher-selection label {
      display: block;
      margin-bottom: 15px;
      font-weight: bold;
      color: var(--primary-blue);
      font-size: 18px;
    }
    
    .radio-group {
      display: flex;
      gap: 25px;
      flex-wrap: wrap;
    }
    
    .radio-label {
      display: flex;
      align-items: center;
      cursor: pointer;
      font-weight: normal;
      color: var(--text-dark);
      position: relative;
      padding-left: 35px;
      font-size: 16px;
      transition: transform 0.2s ease;
    }
    
    .radio-label:hover {
      transform: translateX(5px);
    }
    
    .radio-label input[type="radio"] {
      position: absolute;
      opacity: 0;
      cursor: pointer;
    }
    
    .radio-custom {
      position: absolute;
      top: 0;
      left: 0;
      height: 22px;
      width: 22px;
      background-color: #fff;
      border-radius: 50%;
      border: 2px solid var(--primary-blue);
      transition: all 0.3s ease;
    }
    
    .radio-label input[type="radio"]:checked ~ .radio-custom {
      background-color: var(--primary-blue);
      border-color: var(--primary-blue);
      transform: scale(1.1);
    }
    
    .radio-custom:after {
      content: "";
      position: absolute;
      display: none;
      top: 5px;
      left: 5px;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: white;
    }
    
    .radio-label input[type="radio"]:checked ~ .radio-custom:after {
      display: block;
    }
    
    /* Name Input */
    .name-input {
      margin: 25px 0;
      padding: 20px;
      background: linear-gradient(135deg, #e9f7fe 0%, #cce7ff 100%);
      border-radius: 10px;
      border: 2px solid var(--primary-blue);
    }
    
    .name-input label {
      display: block;
      margin-bottom: 10px;
      font-weight: bold;
      color: var(--primary-blue);
      font-size: 18px;
    }
    
    .name-input input {
      width: 100%;
      padding: 12px 15px;
      font-size: 16px;
      border: 2px solid #ccc;
      border-radius: 6px;
      transition: all 0.3s ease;
    }
    
    .name-input input:focus {
      outline: none;
      border-color: var(--primary-blue);
      box-shadow: 0 0 0 3px rgba(0,120,215,0.2);
    }
    
    .name-input small {
      color: var(--text-light);
      display: block;
      margin-top: 8px;
      font-size: 14px;
    }
    
    /* Start Button */
    .start-button {
      background: linear-gradient(135deg, var(--primary-green) 0%, #1e7e34 100%);
      color: white;
      border: none;
      padding: 15px 40px;
      font-size: 18px;
      cursor: pointer;
      border-radius: 8px;
      margin: 25px auto 0;
      font-weight: bold;
      display: block;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(40,167,69,0.3);
    }
    
    .start-button:hover:not(:disabled) {
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(40,167,69,0.4);
      background: linear-gradient(135deg, #28a745 0%, #1c7430 100%);
    }
    
    .start-button:disabled {
      background: #6c757d;
      cursor: not-allowed;
      box-shadow: none;
    }
    
    /* Modals */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.7);
      z-index: 2000;
      justify-content: center;
      align-items: center;
      animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .modal-content {
      background-color: white;
      padding: 35px;
      border-radius: 12px;
      width: 90%;
      max-width: 500px;
      text-align: center;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      animation: slideUp 0.4s ease;
    }
    
    @keyframes slideUp {
      from { transform: translateY(50px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    .modal h2 {
      color: var(--primary-red);
      margin-top: 0;
      margin-bottom: 20px;
      font-size: 24px;
    }
    
    .modal p {
      margin: 20px 0;
      line-height: 1.6;
      font-size: 16px;
    }
    
    .modal button {
      background-color: var(--primary-red);
      color: white;
      border: none;
      padding: 12px 30px;
      font-size: 16px;
      cursor: pointer;
      border-radius: 6px;
      font-weight: 600;
      margin-top: 10px;
      transition: background-color 0.3s ease;
    }
    
    .modal button:hover {
      background-color: #c62828;
    }
    
    /* Loading Indicator */
    .loading {
      display: none;
      text-align: center;
      padding: 15px;
      color: var(--primary-blue);
      font-size: 16px;
      font-weight: 600;
    }
    
    .loading:after {
      content: '';
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(0,120,215,0.3);
      border-top-color: var(--primary-blue);
      border-radius: 50%;
      margin-left: 10px;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Status Messages */
    .submission-confirmation {
      text-align: center;
      padding: 15px;
      background-color: var(--success-bg);
      color: #155724;
      border: 1px solid #c3e6cb;
      border-radius: 6px;
      margin: 15px 30px;
      font-weight: 600;
      animation: slideDown 0.5s ease;
    }
    
    @keyframes slideDown {
      from { transform: translateY(-20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    .telegram-status {
      text-align: center;
      padding: 15px;
      margin: 15px 30px;
      border-radius: 6px;
      font-weight: 600;
      animation: slideDown 0.5s ease;
    }
    
    .telegram-status.success {
      background-color: var(--success-bg);
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .telegram-status.error {
      background-color: var(--error-bg);
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    /* Responsive Design */
    @media (max-width: 1024px) {
      .main {
        flex-direction: column;
        height: auto;
      }
      
      .left, .right {
        width: 100%;
        max-width: 100%;
        resize: none;
      }
      
      .left {
        border-right: none;
        border-bottom: 4px solid #999;
        min-height: 300px;
        max-height: 50vh;
      }
      
      textarea {
        height: 400px;
      }
    }
    
    @media (max-width: 768px) {
      .header {
        flex-direction: column;
        gap: 15px;
        text-align: center;
      }
      
      .top-right-info {
        align-items: center;
      }
      
      .left, .right {
        padding: 15px 20px;
      }
      
      .rules-container {
        padding: 25px;
      }
      
      .radio-group {
        flex-direction: column;
        gap: 15px;
      }
    }
    
    @media (max-width: 480px) {
      .header, .part-bar, .test-info {
        padding: 12px 15px;
      }
      
      .tab-buttons {
        padding: 0;
      }
      
      .submit-btn, .review-btn {
        width: 90%;
        margin: 10px auto;
      }
    }
    
    /* Print Styles */
    @media print {
      .header, .tab-buttons, .submit-btn, .review-btn {
        display: none;
      }
      
      .main {
        height: auto;
        display: block;
      }
      
      .left, .right {
        width: 100%;
        page-break-inside: avoid;
      }
      
      textarea {
        border: 1px solid #000;
        height: auto;
      }
    }
  </style>
</head>
<body>

  <!-- Rules Screen -->
  <div id="rulesScreen">
    <div class="rules-container">
      <h1>IELTS Writing Test - Set Three</h1>
      <h2>Test Rules and Instructions</h2>
      <p>Please read the following rules carefully before starting your IELTS Writing Test.</p>
      
      <h2>Test Structure</h2>
      <p>The IELTS Writing Test consists of two tasks:</p>
      <ul>
        <li><strong>Task 1:</strong> You should spend about 20 minutes on this task. Write at least 150 words.</li>
        <li><strong>Task 2:</strong> You should spend about 40 minutes on this task. Write at least 250 words.</li>
      </ul>
      
      <h2>Test Duration</h2>
      <p>The total time for the Writing Test is 60 minutes. The timer will start when you click "I Understand" and cannot be paused.</p>
      
      <h2>Important Rules</h2>
      <ul>
        <li>You must complete both writing tasks within the 60-minute time limit.</li>
        <li>You must write your answers in the provided text areas.</li>
        <li>You can switch between Task 1 and Task 2 using the tabs at the bottom of the screen.</li>
        <li>Your work will be automatically saved as a PDF when you click "Submit and Save as PDF" or when time expires.</li>
        <li>Your answers will be sent to the examiner via Telegram for evaluation.</li>
      </ul>
      
      <div class="warning">
        <h2>‚ö†Ô∏è Test Security Rules</h2>
        <p><strong>Important:</strong> To maintain test integrity, the following restrictions apply:</p>
        <ul>
          <li>You <strong>must not</strong> switch to other browser tabs, applications, or windows during the test.</li>
          <li>You <strong>must not</strong> use any external resources, dictionaries, or assistance.</li>
          <li>You <strong>must not</strong> copy, paste, or use keyboard shortcuts to open new tabs or windows.</li>
          <li>You <strong>must not</strong> type at unrealistically high speeds or paste pre-written content.</li>
          <li>If you attempt to leave the test window or type too fast, you will receive a warning.</li>
          <li><strong>Two violations will result in automatic test termination and submission.</strong></li>
        </ul>
      </div>
      
      <h2>Technical Requirements</h2>
      <ul>
        <li>Ensure you have a stable internet connection throughout the test.</li>
        <li>Do not refresh the page or use the browser's back button during the test.</li>
        <li>Your responses will be saved automatically in case of accidental page closure.</li>
      </ul>

      <div class="teacher-selection">
        <label>Select Your Teacher (Required):</label>
        <div class="radio-group">
          <label class="radio-label">
            <input type="radio" name="teacher" value="Mr Doniyor" required>
            <span class="radio-custom"></span>
            Mr Doniyor
          </label>
          <label class="radio-label">
            <input type="radio" name="teacher" value="Mr Xurshid" required>
            <span class="radio-custom"></span>
            Mr Xurshid
          </label>
        </div>
      </div>

      <div class="name-input">
        <label for="studentName">Enter Your Full Name (Required):</label>
        <input type="text" id="studentName" placeholder="Please enter your full name" required>
        <small>Your name will be included in the test submission and PDF.</small>
      </div>
      
      <p style="text-align: center; margin-top: 25px; font-style: italic; color: var(--text-light);">
        By clicking "I Understand" below, you acknowledge that you have read and agree to these rules, and you are ready to begin your IELTS Writing Test.
      </p>
      
      <button class="start-button" id="startButton" onclick="startTest()" disabled>I Understand - Start Test</button>
    </div>
  </div>

  <!-- Test Container -->
  <div id="testContainer">
    <div class="test-info">
      <strong>IELTS Writing Test - Set Three</strong>
    </div>
    
    <div class="header">
      <div class="student-name-display" id="studentNameDisplay"></div>
      <div class="top-right-info">
        <div class="timer-display" id="timer">60:00</div>
        <div class="violation-counter" id="violationCounter">Violations: 0/2</div>
      </div>
      <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/e/e4/IELTS_logo.svg/2560px-IELTS_logo.svg.png" alt="IELTS Logo">
    </div>

    <div id="partBar" class="part-bar">
      Part 1<br>
      You should spend about 20 minutes on this task. Write at least 150 words.
    </div>

    <!-- Task 1 Container -->
    <div class="main" id="mainContainer">
      <div class="left" id="left1">
        <div class="task-content">
          <p class="task-title">The graph below shows the number of inquiries received by the Tourist Information Office in one city over a six-month period in 2011.</p>
          <p class="task-instructions">Summarise the information by selecting and reporting the main features, and make comparisons where relevant.</p>
          <p class="task-instructions">Write at least 150 words.</p>
          <div class="image-container">
            <img src="https://i.ibb.co/4RmQYKpw/line-grapht-task-one.jpg" alt="Tourist Information Office Inquiries - Line Graph" 
                 onerror="this.src='data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22300%22 height=%22200%22><text x=%22150%22 y=%22100%22 text-anchor=%22middle%22>Graph image not available</text></svg>'">
          </div>
        </div>
      </div>
      <div class="right">
        <textarea id="textarea1" spellcheck="false" placeholder="Write your Task 1 response here..." 
                  oninput="updateWordCount('1')" onkeydown="handleTyping('1')" onpaste="handlePaste('1')"></textarea>
        <div class="word-count" id="count1">Words: 0</div>
        <div class="typing-speed" id="speed1">Speed: 0 WPM</div>
      </div>
    </div>

    <!-- Task 2 Container -->
    <div class="main" id="mainContainer2" style="display: none;">
      <div class="left" id="left2">
        <div class="task-content">
          <p class="task-title">In many countries, traditional foods are being replaced by fast food. This has a negative impact on families, individuals, and society. To what extent do you agree or disagree?</p>
          <p class="task-instructions">Discuss both views and give your opinion.</p>
          <p class="task-instructions">Write at least 250 words.</p>
        </div>
      </div>
      <div class="right">
        <textarea id="textarea2" spellcheck="false" placeholder="Write your Task 2 response here..." 
                  oninput="updateWordCount('2')" onkeydown="handleTyping('2')" onpaste="handlePaste('2')"></textarea>
        <div class="word-count" id="count2">Words: 0</div>
        <div class="typing-speed" id="speed2">Speed: 0 WPM</div>
      </div>
    </div>

    <!-- Status Messages -->
    <div class="loading" id="loadingIndicator">Sending answers to examiner... Please wait.</div>
    
    <div id="telegramStatus" class="telegram-status" style="display: none;"></div>
    
    <div id="submissionConfirmation" class="submission-confirmation" style="display: none;">
      ‚úÖ Test submitted successfully! You can now review your answers.
    </div>
    
    <!-- Action Buttons -->
    <button class="submit-btn" id="submitButton" onclick="submitTest()">Submit and Save as PDF</button>
    <button class="review-btn" id="reviewButton" onclick="reviewTest()" style="display: none;">Review Only</button>

    <!-- Tab Navigation -->
    <div class="tab-buttons">
      <button id="tab1" class="active" onclick="switchTab(1)">Part 1</button>
      <button id="tab2" onclick="switchTab(2)">Part 2</button>
    </div>
  </div>

  <!-- Warning Modals -->
  <div id="warningModal" class="modal">
    <div class="modal-content">
      <h2>‚ö†Ô∏è Test Violation Detected</h2>
      <p>You have switched to another application or tab during the test.</p>
      <p>This is a violation of test rules. Your test will be automatically submitted now.</p>
      <button onclick="forceSubmit()">OK</button>
    </div>
  </div>

  <div id="typingWarningModal" class="modal">
    <div class="modal-content">
      <h2>‚ö†Ô∏è Unusual Typing Pattern</h2>
      <p>Your typing speed appears to be unusually high, which may indicate pasting content or using assistance.</p>
      <p>Please ensure you are typing your own responses. Further violations will result in test termination.</p>
      <button onclick="closeTypingWarning()">I Understand</button>
    </div>
  </div>

  <script>
    // Configuration
    const CONFIG = {
      totalTestTime: 60 * 60, // 60 minutes in seconds
      maxWarnings: 2,
      speedThreshold: 120, // Words per minute
      pasteThreshold: 10, // Words pasted at once
      rapidKeystrokeThreshold: 50, // Milliseconds between keystrokes
      maxSpeedViolations: 2
    };

    // State Management
    const state = {
      isTestActive: false,
      isSubmitted: false,
      violationDetected: false,
      warningCount: 0,
      totalSeconds: CONFIG.totalTestTime,
      timer: null,
      studentName: '',
      teacherName: ''
    };

    // Violations Tracking
    const violations = {
      tabSwitching: 0,
      appSwitching: 0,
      highTypingSpeed: 0,
      pasteDetected: 0,
      rapidKeystrokes: 0,
      total: 0
    };

    // Typing Monitoring
    const typingData = {
      task1: {
        lastKeyTime: 0,
        lastWordCount: 0,
        keystrokes: 0,
        lastCalculationTime: 0,
        currentSpeed: 0,
        speedViolations: 0,
        pasteEvents: 0
      },
      task2: {
        lastKeyTime: 0,
        lastWordCount: 0,
        keystrokes: 0,
        lastCalculationTime: 0,
        currentSpeed: 0,
        speedViolations: 0,
        pasteEvents: 0
      }
    };

    // Utility Functions
    function formatTime(seconds) {
      const mins = Math.floor(seconds / 60);
      const secs = seconds % 60;
      return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }

    function countWords(text) {
      return text.trim() === '' ? 0 : text.trim().split(/\s+/).length;
    }

    function escapeTelegramText(text) {
      return text
        .replace(/_/g, '\\_')
        .replace(/\*/g, '\\*')
        .replace(/\[/g, '\\[')
        .replace(/\]/g, '\\]')
        .replace(/\(/g, '\\(')
        .replace(/\)/g, '\\)')
        .replace(/~/g, '\\~')
        .replace(/`/g, '\\`')
        .replace(/>/g, '\\>')
        .replace(/#/g, '\\#')
        .replace(/\+/g, '\\+')
        .replace(/-/g, '\\-')
        .replace(/=/g, '\\=')
        .replace(/\|/g, '\\|')
        .replace(/\{/g, '\\{')
        .replace(/\}/g, '\\}')
        .replace(/\./g, '\\.')
        .replace(/!/g, '\\!');
    }

    // Core Functions
    function initializePage() {
      console.log('Initializing IELTS Writing Test...');
      
      // Show rules screen
      document.getElementById("rulesScreen").style.display = "flex";
      document.getElementById("testContainer").style.display = "none";
      
      // Setup start button validation
      const studentNameInput = document.getElementById("studentName");
      const startButton = document.getElementById("startButton");
      const teacherRadios = document.querySelectorAll('input[name="teacher"]');
      
      function updateStartButton() {
        const isTeacherSelected = Array.from(teacherRadios).some(radio => radio.checked);
        const isNameValid = studentNameInput.value.trim().length >= 2;
        startButton.disabled = !(isTeacherSelected && isNameValid);
        
        if (isTeacherSelected && isNameValid) {
          startButton.innerHTML = `üöÄ I Understand - Start Test`;
        } else {
          startButton.innerHTML = `I Understand - Start Test`;
        }
      }
      
      studentNameInput.addEventListener("input", updateStartButton);
      teacherRadios.forEach(radio => {
        radio.addEventListener("change", updateStartButton);
      });
      
      // Enter key support for name input
      studentNameInput.addEventListener("keypress", function(e) {
        if (e.key === "Enter" && !startButton.disabled) {
          startTest();
        }
      });
      
      // Initialize word counts
      updateWordCount('1');
      updateWordCount('2');
      
      console.log('Page initialized successfully');
    }

    function startTest() {
      const selectedTeacher = document.querySelector('input[name="teacher"]:checked');
      state.studentName = document.getElementById("studentName").value.trim();
      
      if (!selectedTeacher) {
        alert("‚ö†Ô∏è Please select your teacher to start the test.");
        return;
      }
      
      if (state.studentName.length < 2) {
        alert("‚ö†Ô∏è Please enter your full name to start the test.");
        return;
      }
      
      state.teacherName = selectedTeacher.value;
      
      // Switch to test interface
      document.getElementById("rulesScreen").style.display = "none";
      document.getElementById("testContainer").style.display = "block";
      state.isTestActive = true;
      
      // Display student info
      document.getElementById("studentNameDisplay").innerHTML = 
        `<span style="color: var(--primary-blue);">Teacher: ${state.teacherName}</span><br>
         <span style="color: var(--text-dark);">Student: ${state.studentName}</span>`;
      
      // Initialize components
      updateViolationCounter();
      startTimer();
      activateAntiCheating();
      initializeTypingMonitoring();
      
      // Focus on first textarea
      setTimeout(() => {
        document.getElementById("textarea1").focus();
      }, 500);
      
      console.log(`Test started for ${state.studentName} with teacher ${state.teacherName}`);
    }

    function startTimer() {
      const timerDisplay = document.getElementById("timer");
      
      state.timer = setInterval(() => {
        state.totalSeconds--;
        timerDisplay.textContent = formatTime(state.totalSeconds);
        
        // Warning for last 5 minutes
        if (state.totalSeconds === 300) {
          timerDisplay.style.animation = "pulse 1s infinite";
          showNotification("‚è∞ 5 minutes remaining!");
        }
        
        // Auto-submit when time's up
        if (state.totalSeconds <= 0) {
          clearInterval(state.timer);
          if (!state.isSubmitted) {
            showNotification("‚è∞ Time's up! Submitting automatically...");
            setTimeout(submitTest, 1000);
          }
          state.isTestActive = false;
        }
      }, 1000);
    }

    function updateViolationCounter() {
      const counter = document.getElementById("violationCounter");
      counter.textContent = `Violations: ${state.warningCount}/${CONFIG.maxWarnings}`;
      
      if (state.warningCount > 0) {
        counter.style.backgroundColor = "#f8d7da";
        counter.style.color = "#721c24";
        counter.style.borderColor = "#f5c6cb";
      }
      
      if (state.warningCount >= CONFIG.maxWarnings) {
        counter.style.animation = "pulse 0.5s infinite";
      }
    }

    // Anti-Cheating System
    function activateAntiCheating() {
      // Tab switching detection
      document.addEventListener("visibilitychange", function() {
        if (document.hidden && state.isTestActive && !state.violationDetected) {
          violations.tabSwitching++;
          handleViolation('tab_switch', 'Tab switching detected');
        }
      });

      // Window blur detection
      window.addEventListener("blur", function() {
        if (state.isTestActive && !state.violationDetected) {
          violations.appSwitching++;
          handleViolation('app_switch', 'Application switching detected');
        }
      });

      // Prevent context menu
      document.addEventListener('contextmenu', function(e) {
        if (state.isTestActive) {
          e.preventDefault();
        }
      });

      // Prevent keyboard shortcuts
      document.addEventListener('keydown', function(e) {
        if (state.isTestActive && (
          (e.ctrlKey && (e.key === 'c' || e.key === 'v' || e.key === 'x' || e.key === 'z')) ||
          e.key === 'F5' ||
          (e.altKey && e.key === 'Tab') ||
          (e.metaKey && !(e.key === 's' && (navigator.platform.match("Mac") ? e.metaKey : e.ctrlKey)))
        )) {
          e.preventDefault();
        }
      });
    }

    function handleViolation(type, reason) {
      state.violationDetected = true;
      violations.total++;
      state.warningCount++;
      
      updateViolationCounter();
      
      console.log(`Violation detected: ${type} - ${reason}`);
      
      if (state.warningCount >= CONFIG.maxWarnings) {
        // Max violations reached - force submit
        document.getElementById("warningModal").style.display = "flex";
      } else {
        // Show warning
        const messages = {
          'tab_switch': 'Switching browser tabs is not allowed during the test.',
          'app_switch': 'Switching to other applications is not allowed during the test.',
          'typing': 'Unusual typing pattern detected. Please ensure you are typing your own responses.'
        };
        
        showNotification(`‚ö†Ô∏è Warning ${state.warningCount}/${CONFIG.maxWarnings}: ${messages[type] || 'Test rule violation detected.'}`);
        
        // Reset violation flag after delay
        setTimeout(() => {
          state.violationDetected = false;
        }, 2000);
      }
    }

    // Typing Monitoring
    function initializeTypingMonitoring() {
      setInterval(() => {
        calculateTypingSpeed('1');
        calculateTypingSpeed('2');
      }, 3000);
    }

    function handleTyping(task) {
      if (!state.isTestActive || state.isSubmitted) return;
      
      const now = Date.now();
      const data = typingData[`task${task}`];
      
      // Check for rapid keystrokes
      if (data.lastKeyTime > 0) {
        const timeDiff = now - data.lastKeyTime;
        if (timeDiff < CONFIG.rapidKeystrokeThreshold) {
          violations.rapidKeystrokes++;
        }
      }
      
      data.lastKeyTime = now;
      data.keystrokes++;
    }

    function handlePaste(task) {
      if (!state.isTestActive || state.isSubmitted) return;
      
      const data = typingData[`task${task}`];
      const textarea = document.getElementById(`textarea${task}`);
      const beforePasteWords = countWords(textarea.value);
      
      // Use setTimeout to check after paste
      setTimeout(() => {
        const afterPasteWords = countWords(textarea.value);
        const wordIncrease = afterPasteWords - beforePasteWords;
        
        if (wordIncrease > CONFIG.pasteThreshold) {
          data.pasteEvents++;
          violations.pasteDetected++;
          handleTypingViolation(task, `Pasted ${wordIncrease} words detected`);
        }
      }, 100);
    }

    function calculateTypingSpeed(task) {
      const data = typingData[`task${task}`];
      const now = Date.now();
      const textarea = document.getElementById(`textarea${task}`);
      const currentWordCount = countWords(textarea.value);
      
      if (data.lastCalculationTime > 0) {
        const timeDiff = (now - data.lastCalculationTime) / 1000 / 60; // in minutes
        const wordDiff = currentWordCount - data.lastWordCount;
        
        if (timeDiff > 0) {
          data.currentSpeed = Math.round(wordDiff / timeDiff);
          
          const speedElement = document.getElementById(`speed${task}`);
          speedElement.textContent = `Speed: ${data.currentSpeed} WPM`;
          
          if (data.currentSpeed > CONFIG.speedThreshold && wordDiff > 5) {
            speedElement.classList.add('warning');
            violations.highTypingSpeed++;
            handleTypingViolation(task, `High typing speed: ${data.currentSpeed} WPM`);
          } else {
            speedElement.classList.remove('warning');
          }
        }
      }
      
      data.lastCalculationTime = now;
      data.lastWordCount = currentWordCount;
      data.keystrokes = 0;
    }

    function handleTypingViolation(task, reason) {
      const data = typingData[`task${task}`];
      data.speedViolations++;
      
      if (data.speedViolations >= CONFIG.maxSpeedViolations) {
        handleViolation('typing', reason);
        data.speedViolations = 0;
      } else if (data.speedViolations === 1) {
        // Show first warning
        document.getElementById("typingWarningModal").style.display = "flex";
      }
    }

    // UI Functions
    function updateWordCount(part) {
      const text = document.getElementById("textarea" + part).value;
      const wordCount = countWords(text);
      const countElement = document.getElementById("count" + part);
      countElement.textContent = `Words: ${wordCount}`;
      
      const minWords = part === "1" ? 150 : 250;
      if (wordCount < minWords) {
        countElement.classList.add("warning");
      } else {
        countElement.classList.remove("warning");
      }
    }

    function switchTab(part) {
      // Update visibility
      document.getElementById("mainContainer").style.display = part === 1 ? "flex" : "none";
      document.getElementById("mainContainer2").style.display = part === 2 ? "flex" : "none";
      
      // Update tab buttons
      document.getElementById("tab1").classList.remove("active");
      document.getElementById("tab2").classList.remove("active");
      document.getElementById("tab" + part).classList.add("active");
      
      // Update part bar text
      const partText = part === 1
        ? "Part 1<br>You should spend about 20 minutes on this task. Write at least 150 words."
        : "Part 2<br>You should spend about 40 minutes on this task. Write at least 250 words.";
      
      document.getElementById("partBar").innerHTML = partText;
      
      // Focus on textarea
      setTimeout(() => {
        document.getElementById(`textarea${part}`).focus();
      }, 100);
    }

    function showNotification(message) {
      // Create notification element
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #333;
        color: white;
        padding: 15px 20px;
        border-radius: 6px;
        z-index: 3000;
        font-weight: 600;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        animation: slideInRight 0.3s ease;
      `;
      notification.textContent = message;
      
      document.body.appendChild(notification);
      
      // Remove after 3 seconds
      setTimeout(() => {
        notification.style.animation = 'fadeOut 0.3s ease';
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }

    // Submission Functions
    async function submitTest() {
      if (state.isSubmitted) {
        showNotification("Test has already been submitted.");
        return;
      }
      
      // Show loading
      document.getElementById("loadingIndicator").style.display = "block";
      document.getElementById("submitButton").disabled = true;
      
      // Get answers
      const task1Answer = document.getElementById("textarea1").value;
      const task2Answer = document.getElementById("textarea2").value;
      const task1WordCount = countWords(task1Answer);
      const task2WordCount = countWords(task2Answer);
      const totalWords = task1WordCount + task2WordCount;
      
      // Calculate time used
      const timeUsed = CONFIG.totalTestTime - state.totalSeconds;
      const minutesUsed = Math.floor(timeUsed / 60);
      const secondsUsed = timeUsed % 60;
      
      // Prepare Telegram message
      const telegramMessage = `üìù *IELTS WRITING TEST SUBMITTED*

üë§ *STUDENT INFORMATION*
‚Ä¢ Name: ${escapeTelegramText(state.studentName)}
‚Ä¢ Teacher: ${escapeTelegramText(state.teacherName)}
‚Ä¢ Test: IELTS Writing Test \\- Set Three
‚Ä¢ Timestamp: ${new Date().toLocaleString()}
‚Ä¢ Duration: ${minutesUsed}m ${secondsUsed}s

üìã *TASK 1 \\- GRAPH DESCRIPTION*
*Question:*
The graph below shows the number of inquiries received by the Tourist Information Office in one city over a six\\-month period in 2011\\.

Summarise the information by selecting and reporting the main features, and make comparisons where relevant\\.

Write at least 150 words\\.

*Student's Answer:*
${escapeTelegramText(task1Answer)}

üìä *Task 1 Statistics:*
‚Ä¢ Words: ${task1WordCount}
‚Ä¢ Required: 150 words ${task1WordCount < 150 ? '‚ùå' : '‚úÖ'}

üìù *TASK 2 \\- ESSAY WRITING*
*Question:*
In many countries, traditional foods are being replaced by fast food\\.
This has a negative impact on families, individuals, and society\\.
To what extent do you agree or disagree\\?

*Student's Answer:*
${escapeTelegramText(task2Answer)}

üìä *Task 2 Statistics:*
‚Ä¢ Words: ${task2WordCount}
‚Ä¢ Required: 250 words ${task2WordCount < 250 ? '‚ùå' : '‚úÖ'}

üìà *OVERALL STATISTICS*
‚Ä¢ Total Words Written: ${totalWords}
‚Ä¢ Task 1 Words: ${task1WordCount} ${task1WordCount < 150 ? "‚ùå" : "‚úÖ"}
‚Ä¢ Task 2 Words: ${task2WordCount} ${task2WordCount < 250 ? "‚ùå" : "‚úÖ"}
‚Ä¢ Time Used: ${minutesUsed}m ${secondsUsed}s

üö® *VIOLATION REPORT*
‚Ä¢ Total Violations: ${violations.total}
‚Ä¢ Tab Switching: ${violations.tabSwitching}
‚Ä¢ App Switching: ${violations.appSwitching}
‚Ä¢ High Typing Speed: ${violations.highTypingSpeed}
‚Ä¢ Paste Detected: ${violations.pasteDetected}
‚Ä¢ Rapid Keystrokes: ${violations.rapidKeystrokes}
‚Ä¢ Final Warnings: ${state.warningCount}/${CONFIG.maxWarnings}

\\-\\-\\-
‚úÖ Test automatically submitted and recorded
üïí System Time: ${new Date().toLocaleString()}`;

      console.log('Sending Telegram message...');
      
      try {
        // Send to Telegram
        const telegramResult = await sendToTelegram(telegramMessage);
        
        // Hide loading
        document.getElementById("loadingIndicator").style.display = "none";
        
        // Show Telegram status
        const statusElement = document.getElementById("telegramStatus");
        statusElement.style.display = "block";
        
        if (telegramResult.success) {
          statusElement.textContent = "‚úÖ Test submitted successfully! Telegram message sent.";
          statusElement.className = "telegram-status success";
          console.log('‚úÖ Telegram message sent successfully!');
        } else {
          statusElement.textContent = `‚ö†Ô∏è Test submitted but failed to send to Telegram: ${telegramResult.error}`;
          statusElement.className = "telegram-status error";
          console.error('‚ùå Telegram failed:', telegramResult.error);
        }
        
        // Generate PDF
        downloadPDF(task1Answer, task2Answer, task1WordCount, task2WordCount);
        
      } catch (error) {
        console.error('Submission error:', error);
        document.getElementById("loadingIndicator").style.display = "none";
        showNotification("‚ö†Ô∏è Error submitting test. Please try again.");
        return;
      }
      
      // Update state
      state.isTestActive = false;
      state.isSubmitted = true;
      clearInterval(state.timer);
      
      // Update UI
      document.getElementById("submitButton").style.display = "none";
      document.getElementById("reviewButton").style.display = "block";
      document.getElementById("submissionConfirmation").style.display = "block";
      
      // Disable text areas
      document.getElementById("textarea1").disabled = true;
      document.getElementById("textarea2").disabled = true;
      
      console.log('Test submitted successfully');
    }

    async function sendToTelegram(message) {
      try {
        console.log('Starting Telegram API call...');
        
        const response = await fetch('/api/telegram', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            message: message,
            studentName: state.studentName,
            teacherName: state.teacherName
          })
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();
        console.log('Telegram API response:', result);
        
        return result;
      } catch (error) {
        console.error('Telegram API error:', error);
        return { 
          success: false, 
          error: error.message || 'Network error' 
        };
      }
    }

    function downloadPDF(task1Answer, task2Answer, task1WordCount, task2WordCount) {
      try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // Header
        doc.setFontSize(20);
        doc.setTextColor(0, 120, 215);
        doc.text("IELTS Writing Test - Set Three", 20, 20);
        
        doc.setFontSize(12);
        doc.setTextColor(0, 0, 0);
        doc.text(`Teacher: ${state.teacherName}`, 20, 35);
        doc.text(`Student: ${state.studentName}`, 20, 45);
        doc.text(`Date: ${new Date().toLocaleDateString()}`, 20, 55);
        doc.text(`Time: ${new Date().toLocaleTimeString()}`, 20, 65);
        doc.text(`Violations: ${violations.total}`, 20, 75);

        // Task 1
        doc.setFontSize(16);
        doc.setTextColor(0, 0, 0);
        doc.text("Writing Task 1", 20, 95);
        doc.setFontSize(12);
        doc.text(`Word Count: ${task1WordCount}`, 20, 105);
        
        doc.text("Answer:", 20, 120);
        const answer1Lines = doc.splitTextToSize(task1Answer, 170);
        doc.text(answer1Lines, 20, 130);

        // Task 2 (new page)
        doc.addPage();
        doc.setFontSize(16);
        doc.text("Writing Task 2", 20, 20);
        doc.setFontSize(12);
        doc.text(`Word Count: ${task2WordCount}`, 20, 30);
        
        doc.text("Answer:", 20, 45);
        const answer2Lines = doc.splitTextToSize(task2Answer, 170);
        doc.text(answer2Lines, 20, 55);

        // Footer
        const pageCount = doc.internal.getNumberOfPages();
        for(let i = 1; i <= pageCount; i++) {
          doc.setPage(i);
          doc.setFontSize(10);
          doc.text(`Page ${i} of ${pageCount}`, 180, 285);
        }

        // Save PDF
        const fileName = `IELTS_Writing_${state.studentName.replace(/\s+/g, '_')}_${Date.now()}.pdf`;
        doc.save(fileName);
        
        console.log('PDF generated:', fileName);
      } catch (error) {
        console.error('PDF generation error:', error);
        showNotification("‚ö†Ô∏è Error generating PDF. Test submitted but PDF not downloaded.");
      }
    }

    function reviewTest() {
      showNotification("üìñ You are now in review mode. You can read your answers but cannot make changes.");
    }

    function forceSubmit() {
      state.isTestActive = false;
      state.violationDetected = false;
      document.getElementById("warningModal").style.display = "none";
      submitTest();
      clearInterval(state.timer);
    }

    function closeTypingWarning() {
      document.getElementById("typingWarningModal").style.display = "none";
    }

    // Add CSS for notifications
    const style = document.createElement('style');
    style.textContent = `
      @keyframes slideInRight {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
      
      @keyframes fadeOut {
        from { opacity: 1; }
        to { opacity: 0; }
      }
    `;
    document.head.appendChild(style);

    // Initialize when page loads
    window.onload = initializePage;
    
    // Prevent accidental navigation
    window.addEventListener('beforeunload', function(e) {
      if (state.isTestActive && !state.isSubmitted) {
        e.preventDefault();
        e.returnValue = 'Your test progress will be lost if you leave this page. Are you sure?';
      }
    });
  </script>
</body>
</html>
